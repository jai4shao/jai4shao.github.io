<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title id="pageTitle"></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      background-color: #FDF6E3;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      font-size: 40px;
    }
    h2 {
      text-align: center;
      font-size: 44px;
      margin: 10px 0 20px 0;
    }
    .calendar-container {
      overflow-x: auto;
      width: 100%;
    }
    table {
      width: 100%;
      min-width: 700px;
      border-collapse: collapse;
      margin: 10px 0 20px 0;
      background: #fff;
      font-size: 40px;
    }
    th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 10px 2px;
      min-width: 80px;
      font-size: 40px;
    }
    th {
      background: #f5f5f5;
    }
    th.sunday, td.sunday {
      background: #FFD1DC;
    }
    th.saturday, td.saturday {
      background: #D0F5D8;
    }
    select {
      width: 90%;
      padding: 8px;
      font-size: 40px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .input-group {
      margin: 32px 0;
    }
    label {
      display: block;
      margin-bottom: 12px;
      font-weight: bold;
      font-size: 40px;
    }
    input[type="text"] {
      width: 100%;
      padding: 18px;
      font-size: 40px;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      display: block;
      width: 100%;
      margin: 36px auto 0 auto;
      padding: 24px 0;
      background: #A8E6CF; /* 舒適綠色 */
      color: #22543D;
      border: none;
      border-radius: 8px;
      font-size: 44px;
      cursor: pointer;
      font-weight: bold;
    }
    button:active {
      background: #81C784;
    }
    #lineIdShow {
      font-size:32px; color:#888; margin-bottom:10px;
    }
    @media (max-width: 700px) {
      table {
        font-size: 28px;
        min-width: 500px;
      }
      th, td {
        font-size: 28px;
        min-width: 50px;
        padding: 6px 1px;
      }
      select, input[type="text"], label, button {
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
  <h2 id="title"></h2>
  <div id="lineIdShow"></div>
  <form id="shiftForm" autocomplete="off">
    <div class="calendar-container">
      <table id="calendarTable"></table>
    </div>
    <div class="input-group">
      <label for="remark">備註</label>
      <input type="text" id="remark" name="remark" autocomplete="off">
    </div>
    <div class="input-group">
      <label id="lastMonth6Label" for="lastMonth6"></label>
      <input type="text" id="lastMonth6" name="lastMonth6" autocomplete="off">
    </div>
    <button type="submit" id="submitBtn">送出班表</button>
  </form>
  <script>
    // 請填入您的 LIFF ID
    const liffId = "2007431269-rQ7vYpWB";
    // 請填入您的 GAS 網頁應用程式網址
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzhl04WrGN7ARqUkEBQ4FZ1P_drIUmwxuzn81mZeQevVWnnFP425JAnjaU3VuqCn9Xo/exec";

    let lineId = "";

    // LIFF 初始化
    async function initLiff() {
      document.getElementById('lineIdShow').textContent = "讀取中...";
      try {
        await liff.init({ liffId });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        const profile = await liff.getProfile();
        lineId = profile.userId;
        document.getElementById('lineIdShow').textContent = "您的 Line ID：" + lineId + "，名稱：" + profile.displayName;
      } catch (e) {
        document.getElementById('lineIdShow').textContent = "LIFF 初始化失敗：" + e;
      }
    }

    // 取得當下年月
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1; // 1~12
    const lastMonth = month === 1 ? 12 : month - 1;
    const lastMonthYear = month === 1 ? year - 1 : year;

    // 設定標題
    document.getElementById('title').textContent = `${year}年${month}月約班表`;
    document.getElementById('pageTitle').textContent = `${year}年${month}月約班表`;
    document.getElementById('lastMonth6Label').textContent = `${lastMonthYear}年${lastMonth}月底六天班`;

    // 取得當月天數
    function getDaysInMonth(y, m) {
      return new Date(y, m, 0).getDate();
    }
    const daysInMonth = getDaysInMonth(year, month);

    // 取得本月1號是星期幾（0:日~6:六）
    const firstDay = new Date(year, month - 1, 1).getDay();

    // 取得下拉選單選項（從 GAS 取得）
    let selectOptions = [];
    async function loadSettings() {
      try {
        const res = await fetch(GAS_URL + "?action=getSettings");
        const options = await res.json();
        if (!options || options.length === 0) {
          alert("下拉選單設定為空，請檢查 setting 分頁！");
        }
        selectOptions = options;
        buildCalendar();
      } catch (e) {
        alert("取得下拉選單失敗：" + e);
      }
    }

    // 建立行事曆表格
    function buildCalendar() {
      const table = document.getElementById('calendarTable');
      table.innerHTML = '';
      // 星期標題
      const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
      const trHead = document.createElement('tr');
      weekDays.forEach((d, i) => {
        const th = document.createElement('th');
        th.textContent = d;
        if (i === 0) th.className = 'sunday';
        if (i === 6) th.className = 'saturday';
        trHead.appendChild(th);
      });
      table.appendChild(trHead);

      // 日期與下拉選單
      let tr = document.createElement('tr');
      let day = 1;
      // 填入空白
      for (let i = 0; i < firstDay; i++) {
        tr.appendChild(document.createElement('td'));
      }
      for (let i = firstDay; i < 7; i++) {
        tr.appendChild(createDayCell(day, i));
        day++;
      }
      table.appendChild(tr);

      while (day <= daysInMonth) {
        tr = document.createElement('tr');
        for (let i = 0; i < 7; i++) {
          if (day > daysInMonth) {
            tr.appendChild(document.createElement('td'));
          } else {
            tr.appendChild(createDayCell(day, i));
            day++;
          }
        }
        table.appendChild(tr);
      }
    }

    // 建立單一天的 cell
    function createDayCell(day, weekIdx) {
      const td = document.createElement('td');
      if (weekIdx === 0) td.className = 'sunday';
      if (weekIdx === 6) td.className = 'saturday';
      td.innerHTML = `<div>${day}</div>`;
      // 下拉選單
      const select = document.createElement('select');
      select.name = `day${day}`;
      const emptyOpt = document.createElement('option');
      emptyOpt.value = '';
      emptyOpt.textContent = '';
      select.appendChild(emptyOpt);
      selectOptions.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
      });
      td.appendChild(select);
      return td;
    }

    // 表單送出
    document.getElementById('shiftForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const data = {
        days: {},
        remark: document.getElementById('remark').value,
        lastMonth6: document.getElementById('lastMonth6').value,
        lineId: lineId
      };
      for (let i = 1; i <= daysInMonth; i++) {
        const val = document.querySelector(`select[name="day${i}"]`).value;
        data.days[i] = val;
      }
try {
  const params = new URLSearchParams();
  params.append('action', 'submitData');
  params.append('data', JSON.stringify(data));

  const res = await fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: params.toString()
  });
  const result = await res.json();
  if (result && result.success) {
    alert('送出成功！');
    document.getElementById('shiftForm').reset();
  } else {
    alert('送出失敗！');
  }
} catch (e) {
  alert('送出失敗：' + e);
}
    });

    // 初始化
    window.onload = async function() {
      await initLiff();
      await loadSettings();
    };
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>LINE約班</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
  /* 🔄 載入提示 */
  #loadingOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2em;
    font-weight: bold;
    z-index: 9999;
  }

  #loadingOverlay::after {
    content: "🔄 載入中，請稍候…";
    animation: blink 1.2s infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* 基本樣式 */
  body {
    font-family: sans-serif;
    background: #f9fbe7;
    margin: 0;
    font-size: 100%;
  }

  h2 {
    text-align: center;
    font-size: 1.4em;
  }

  .block {
    margin-top: 20px;
    padding: 10px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
  }

  input, button, select {
    width: 100%;
    padding: 10px;
    margin-top: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1em;
    box-sizing: border-box;
  }

  button {
    background: #aed581;
    cursor: pointer;
  }

  button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  #calendarArea {
    padding: 0;
    border: none;
    background: none;
    box-shadow: none;
  }

  #calendarArea table {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
    margin: 0 auto;
    background-color: #fff;
  }

  #calendarArea td, #calendarArea th {
    padding: 2px;
    vertical-align: top;
    border: 1px solid #bbb;
  }

  .sunday {
    background-color: #ffe4e1;
  }

  .saturday {
    background-color: #e0f7e9;
  }

  td > div:first-child {
    margin-bottom: 0em;
  }

  .desc {
    font-size: 1em;
    color: #625b57;
    text-align: center;
    font-weight: bold;
    margin-top: 0.4em;
  }

  .desc-r {
    color: red;
  }
    
.custom-select-wrapper {
  position: relative; /* 使 ::after 能夠相對定位 */
}
    
  /* 下拉選單 */
.custom-select-wrapper select {
  padding-top: 4px;
  padding-bottom: 4px;
  font-size: 0.9em;
  width: 100%;
  border-radius: 4px;
  height: 36px;
  color: #333;            /* 設置預設文字顏色 */
  background-color: #fff; /* 設置背景顏色 */
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-image: url("data:image/svg+xml;utf8,<svg fill='orange' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat: no-repeat;
  background-size: contain;
  background-position: center;
  padding-right: 2.5em; /* 預留空間給箭頭圖示 */
  box-sizing: border-box;
}

/* 設置選項文字顏色 */
.custom-select-wrapper select option {
  color: #333;                  /* 設置文字顏色 */
  background-color: #fff;       /* 設置選項的背景顏色 */
}

/* 如果選項背景色要與選單背景色相同 */
.custom-select-wrapper select:disabled option {
  color: #aaa;                  /* 禁用狀態的文字顏色 */
  background-color: #f0f0f0;    /* 禁用選項的背景顏色 */
}
  
  #saveResult {
    text-align: center;
    margin-top: 0.5em;
    font-weight: bold;
    font-size: 0.95em;
  }
    /* 預約按鈕禁用樣式 */
button:disabled {
  background-color: #ccc;  /* 灰色背景 */
  cursor: not-allowed;     /* 禁用游標 */
}

button.disabled {
  background-color: #ccc;  /* 灰色背景 */
  color: #999;              /* 灰色文字 */
}

/* 預約按鈕啟用狀態 */
button {
  background-color: #aed581;  /* 綠色背景 */
  color: #fff;
  cursor: pointer;
}

</style>


</head>
<body>
  <div id="loadingOverlay"></div>

  <!-- 註冊區 -->
  <div id="registerArea" class="block" style="display:none;">
    <p>即將綁定的 <strong>LINE ID</strong> 為：</p>
    <p id="displayLineId" style="font-weight:bold; color:#444"></p>
    <p style="color:#d32f2f;">
      ⚠️ 此帳號將與輸入的註冊碼永久綁定。<br/>
      請確認您已登入正確的 Line 帳號。如有問題請聯絡管理員。
    </p>
    <label><input type="checkbox" id="confirmLineId" />我已確認上述 Line ID 正確無誤</label>
    <input type="text" id="registerCode" placeholder="請輸入註冊碼" />
    <button id="registerBtn" disabled>送出註冊</button>
    <p id="registerResult"></p>
  </div>

  <!-- 行事曆區 -->
  <div id="calendarArea" style="display:none;">
    <h2 id="calendarTitle"></h2>
    <div id="calendarTable"></div>
    <div id="extraFields" style="margin-bottom: 1em;">
      <br>
      <label><strong id="sixDaysLabel">的六天班：</strong>
        <input type="text" id="sixDaysInput" placeholder="例如：NNNRRE" />
      </label>
      <br>
      <label><strong>備註：</strong>
        <input type="text" id="noteInput" placeholder="例如：本月無約班需求" />
      </label>
    </div>
    <button id="saveBtn" style="display:none;">儲存班表</button>
    <div id="saveResult"></div>
  </div>

  <script>
    const liffId = "2007428519-oW2eNAkw";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbywKRqPRyOcKiBirnV5-F2gdemC9q1nD0-5tAqhCfoA5qkDxcvWBdCyGYId68Xw7V8V/exec";
    let lineId = "";

    async function init() {
      await liff.init({ liffId });
      if (!liff.isLoggedIn()) liff.login();
      const profile = await liff.getProfile();
      lineId = profile.userId;
      document.getElementById("displayLineId").textContent = lineId;
      await checkRegistration();

      // ✅ 資料處理完成才關閉 loading
      document.getElementById("loadingOverlay").style.display = "none";
    }

    async function checkRegistration() {
      const form = new URLSearchParams();
      form.append("lineId", lineId);
      const res = await fetch(GAS_URL, { method: "POST", body: form });
      const text = await res.text();

      if (text === "found") {
        document.getElementById("calendarArea").style.display = "block";
        await generateCalendar();
      } else {
        document.getElementById("registerArea").style.display = "block";
      }
    }

    document.getElementById("registerBtn").onclick = async () => {
      const code = document.getElementById("registerCode").value.trim();
      if (!code) return;

      const form = new URLSearchParams({ lineId, code });
      const res = await fetch(GAS_URL, { method: "POST", body: form });
      const text = await res.text();
      document.getElementById("registerResult").textContent = text;

      if (text.includes("成功")) {
        document.getElementById("registerArea").style.display = "none";
        document.getElementById("calendarArea").style.display = "block";
        await generateCalendar();
      }
    };

    async function generateCalendar() {
      const titleEl = document.getElementById("calendarTitle");
      const res = await fetch(`${GAS_URL}?lineId=${lineId}`);
      const result = await res.json();
      const saved = result.schedule || {};

      document.getElementById("sixDaysInput").value = result.sixDays || "";
      document.getElementById("noteInput").value = result.note || "";

      const today = new Date();
      const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
      const year = nextMonth.getFullYear();
      const month = nextMonth.getMonth();

      titleEl.textContent = `${year}年${month + 1}月LINE約班`;
      document.getElementById("sixDaysLabel").textContent = `${today.getFullYear()}年${today.getMonth() + 1}月底的六天班：`;

      const table = document.createElement("table");
      const days = ["日", "一", "二", "三", "四", "五", "六"];
      const head = document.createElement("tr");

      days.forEach(day => {
        const th = document.createElement("th");
        th.textContent = day;
        head.appendChild(th);
      });

      table.appendChild(head);

      let date = 1;
      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < 6; i++) {
        const tr = document.createElement("tr");

        for (let j = 0; j < 7; j++) {
          const td = document.createElement("td");

          if (j === 0) td.classList.add("sunday");
          if (j === 6) td.classList.add("saturday");

          if (i === 0 && j < firstDay) {
            td.innerHTML = "";
          } else if (date <= lastDate) {
            const dayStr = String(date).padStart(2, "0");
            const fullDate = `${year}-${String(month + 1).padStart(2, "0")}-${dayStr}`;

            const label = document.createElement("div");
            label.textContent = date;

            const select = document.createElement("select");
            select.name = fullDate;

            ["", "R", "D", "E", "N", "公假"].forEach(val => {
              const opt = document.createElement("option");
              opt.value = val;
              opt.textContent = val;
              if (saved[dayStr] === val) opt.selected = true;
              select.appendChild(opt);
            });

            const desc = document.createElement("div");
            desc.className = "desc";
            if (saved[dayStr]) {
              const code = saved[dayStr];
              desc.textContent = code;
              if (code === "R") desc.classList.add("desc-r");
            }

            select.addEventListener("change", function () {
              const val = this.value;
              desc.textContent = val || "";
              desc.className = "desc";
              if (val === "R") desc.classList.add("desc-r");
            });

            td.appendChild(label);
            const wrapper = document.createElement("div");
            wrapper.className = "custom-select-wrapper";
            wrapper.appendChild(select);
            td.appendChild(wrapper);
            select.classList.add("faint-select");
            td.appendChild(desc);
            date++;
          }

          tr.appendChild(td);
        }

        table.appendChild(tr);
        if (date > lastDate) break;
      }

      const holder = document.getElementById("calendarTable");
      holder.innerHTML = "";
      holder.appendChild(table);
      document.getElementById("saveBtn").style.display = "block";
    }

    document.getElementById("saveBtn").onclick = async () => {
      const btn = document.getElementById("saveBtn");
      const result = document.getElementById("saveResult");

      btn.disabled = true;
      btn.textContent = "送出中，請稍候…";
      result.textContent = "";

      try {
        const selects = document.querySelectorAll("select[name]");
        const calendar = {};
        selects.forEach(sel => calendar[sel.name] = sel.value);

        const sixDays = document.getElementById("sixDaysInput").value.trim();
        const note = document.getElementById("noteInput").value.trim();

        const form = new URLSearchParams({
          lineId,
          calendar: JSON.stringify(calendar),
          sixDays,
          note
        });

        const res = await fetch(GAS_URL, { method: "POST", body: form });
        const text = await res.text();

        alert("✅ 資料已成功送出！");
        liff.closeWindow();
      } catch (err) {
        result.textContent = "⚠️ 發生錯誤，請稍後再試！";
        result.style.color = "#d32f2f";
        console.error(err);
        btn.disabled = false;
        btn.textContent = "儲存班表";
      }
    };

    document.getElementById("confirmLineId").addEventListener("change", function () {
      document.getElementById("registerBtn").disabled = !this.checked;
    });

    window.onload = function() {
  // 原來的 init 函數（如果有的話）可以放在這裡
  init();  // 若你的 init 函數有需要繼續執行，保留這行
  
  // 檢查當前時間
  const now = new Date();
  const dayOfMonth = now.getDate();  // 當天是這個月的幾號
  const hours = now.getHours();      // 當前小時
  const minutes = now.getMinutes(); // 當前分鐘

  // 預約按鈕
  const reserveBtn = document.getElementById("reserveBtn");
  const reserveBtnText = document.getElementById("reserveBtnText");
  
  // 註冊按鈕
  const registerBtn = document.getElementById("registerBtn");

  // 預約時間條件：1號到15號，且時間是12:30之前
  if ((dayOfMonth >= 1 && dayOfMonth <= 25) && (hours < 12 || (hours === 12 && minutes <= 30))) {
    reserveBtn.disabled = false;  // 啟用預約按鈕
    reserveBtn.classList.remove("disabled");  // 移除禁用樣式
    reserveBtnText.textContent = "預約";   // 顯示「預約」文字
  } else {
    reserveBtn.disabled = true;   // 禁用預約按鈕
    reserveBtn.classList.add("disabled");  // 顯示禁用樣式
    reserveBtnText.textContent = "目前非預約時段"; // 顯示「目前非預約時段」文字
  }

  // 註冊按鈕：無論時間如何，按下後禁用
  registerBtn.onclick = function() {
    this.disabled = true;
    this.textContent = "正在處理...";  // 改變按鈕文字為「正在處理...」
    // 這裡可以加入註冊的處理邏輯
  }
}

  </script>
</body>
</html>

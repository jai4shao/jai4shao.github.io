<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>LINEç´„ç­</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    /* ğŸ”„ è¼‰å…¥ä¸­æç¤º */
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      font-weight: bold;
      z-index: 9999;
    }

    #loadingOverlay::after {
      content: "ğŸ”„ è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™â€¦";
      animation: blink 1.2s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    body {
      font-family: sans-serif;
      background: #f9fbe7;
      margin: 0;
      font-size: 100%;
    }

    h2 {
      text-align: center;
      font-size: 1.4em;
    }

    .block {
      margin-top: 20px;
      padding: 10px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    input, button, select {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1em;
      box-sizing: border-box;
    }

    button {
      background: #aed581;
      cursor: pointer;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #calendarArea {
      padding: 0;
      border: none;
      background: none;
      box-shadow: none;
    }

    #calendarArea table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      margin: 0 auto;
      background-color: #fff;
    }

    #calendarArea td, #calendarArea th {
      padding: 4px 2px;
      vertical-align: top;
      border: 1px solid #bbb;
    }

    .sunday {
      background-color: #ffe4e1;
    }

    .saturday {
      background-color: #e0f7e9;
    }

    td > div:first-child {
      margin-bottom: 0.1em; /* æ›´ç·Šå¯† */
    }

    .desc {
      font-size: 1.1em;
      color: #625b57;
      text-align: center;
      font-weight: bold;
    }

    .desc-r {
      color: red;
    }

    .faint-select {
      background-color: #eee;
      color: #eee;
      border: 1px solid #ccc;
      padding: 4px 6px;
      font-size: 1em;
      border-radius: 4px;
    }

    .faint-select option {
      color: #333;
    }

    .custom-select-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .custom-select-wrapper::after {
      content: "ğŸ”½";
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      font-size: 0.9em;
      color: #888;
    }

    #saveResult {
      text-align: center;
      margin-top: 0.5em;
      font-weight: bold;
      font-size: 0.95em;
    }
  </style>
</head>
<body>
  <div id="loadingOverlay"></div>

  <!-- è¨»å†Šå€ -->
  <div id="registerArea" class="block" style="display:none;">
    <p>å³å°‡ç¶å®šçš„ <strong>LINE ID</strong> ç‚ºï¼š</p>
    <p id="displayLineId" style="font-weight:bold; color:#444"></p>
    <p style="color:#d32f2f;">
      âš ï¸ æ­¤å¸³è™Ÿå°‡èˆ‡è¼¸å…¥çš„è¨»å†Šç¢¼æ°¸ä¹…ç¶å®šã€‚<br/>
      è«‹ç¢ºèªæ‚¨å·²ç™»å…¥æ­£ç¢ºçš„ Line å¸³è™Ÿã€‚å¦‚æœ‰å•é¡Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚
    </p>
    <label><input type="checkbox" id="confirmLineId" />æˆ‘å·²ç¢ºèªä¸Šè¿° Line ID æ­£ç¢ºç„¡èª¤</label>
    <input type="text" id="registerCode" placeholder="è«‹è¼¸å…¥è¨»å†Šç¢¼" />
    <button id="registerBtn" disabled>é€å‡ºè¨»å†Š</button>
    <p id="registerResult"></p>
  </div>

  <!-- è¡Œäº‹æ›†å€ -->
  <div id="calendarArea" style="display:none;">
    <h2 id="calendarTitle"></h2>
    <div id="calendarTable"></div>
    <div id="extraFields" style="margin-bottom: 1em;">
      <label><strong id="sixDaysLabel">çš„å…­å¤©ç­ï¼š</strong>
        <input type="text" id="sixDaysInput" placeholder="ä¾‹å¦‚ï¼šNNNRRE" />
      </label>
      <br><br>
      <label><strong>å‚™è¨»ï¼š</strong>
        <input type="text" id="noteInput" placeholder="ä¾‹å¦‚ï¼šæœ¬æœˆç„¡ç´„ç­éœ€æ±‚" />
      </label>
    </div>
    <button id="saveBtn" style="display:none;">å„²å­˜ç­è¡¨</button>
    <div id="saveResult"></div>
  </div>

  <script>
    const liffId = "2007428519-oW2eNAkw";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbywKRqPRyOcKiBirnV5-F2gdemC9q1nD0-5tAqhCfoA5qkDxcvWBdCyGYId68Xw7V8V/exec";
    let lineId = "";

    async function init() {
      await liff.init({ liffId });
      if (!liff.isLoggedIn()) liff.login();
      const profile = await liff.getProfile();
      lineId = profile.userId;
      document.getElementById("displayLineId").textContent = lineId;
      await checkRegistration();

      // âœ… è³‡æ–™è™•ç†å®Œæˆæ‰é—œé–‰ loading
      document.getElementById("loadingOverlay").style.display = "none";
    }

    async function checkRegistration() {
      const form = new URLSearchParams();
      form.append("lineId", lineId);
      const res = await fetch(GAS_URL, { method: "POST", body: form });
      const text = await res.text();

      if (text === "found") {
        document.getElementById("calendarArea").style.display = "block";
        await generateCalendar();
      } else {
        document.getElementById("registerArea").style.display = "block";
      }
    }

    document.getElementById("registerBtn").onclick = async () => {
      const code = document.getElementById("registerCode").value.trim();
      if (!code) return;

      const form = new URLSearchParams({ lineId, code });
      const res = await fetch(GAS_URL, { method: "POST", body: form });
      const text = await res.text();
      document.getElementById("registerResult").textContent = text;

      if (text.includes("æˆåŠŸ")) {
        document.getElementById("registerArea").style.display = "none";
        document.getElementById("calendarArea").style.display = "block";
        await generateCalendar();
      }
    };

    async function generateCalendar() {
      const titleEl = document.getElementById("calendarTitle");
      const res = await fetch(`${GAS_URL}?lineId=${lineId}`);
      const result = await res.json();
      const saved = result.schedule || {};

      document.getElementById("sixDaysInput").value = result.sixDays || "";
      document.getElementById("noteInput").value = result.note || "";

      const today = new Date();
      const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
      const year = nextMonth.getFullYear();
      const month = nextMonth.getMonth();

      titleEl.textContent = `${year}å¹´${month + 1}æœˆLINEç´„ç­`;
      document.getElementById("sixDaysLabel").textContent = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆåº•çš„å…­å¤©ç­ï¼š`;

      const table = document.createElement("table");
      const days = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
      const head = document.createElement("tr");

      days.forEach(day => {
        const th = document.createElement("th");
        th.textContent = day;
        head.appendChild(th);
      });

      table.appendChild(head);

      let date = 1;
      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < 6; i++) {
        const tr = document.createElement("tr");

        for (let j = 0; j < 7; j++) {
          const td = document.createElement("td");

          if (j === 0) td.classList.add("sunday");
          if (j === 6) td.classList.add("saturday");

          if (i === 0 && j < firstDay) {
            td.innerHTML = "";
          } else if (date <= lastDate) {
            const dayStr = String(date).padStart(2, "0");
            const fullDate = `${year}-${String(month + 1).padStart(2, "0")}-${dayStr}`;

            const label = document.createElement("div");
            label.textContent = date;

            const select = document.createElement("select");
            select.name = fullDate;

            ["", "R", "D", "E", "N", "å…¬å‡"].forEach(val => {
              const opt = document.createElement("option");
              opt.value = val;
              opt.textContent = val;
              if (saved[dayStr] === val) opt.selected = true;
              select.appendChild(opt);
            });

            const desc = document.createElement("div");
            desc.className = "desc";
            if (saved[dayStr]) {
              const code = saved[dayStr];
              desc.textContent = code;
              if (code === "R") desc.classList.add("desc-r");
            }

            select.addEventListener("change", function () {
              const val = this.value;
              desc.textContent = val || "";
              desc.className = "desc";
              if (val === "R") desc.classList.add("desc-r");
            });

            td.appendChild(label);
            const wrapper = document.createElement("div");
            wrapper.className = "custom-select-wrapper";
            wrapper.appendChild(select);
            td.appendChild(wrapper);
            select.classList.add("faint-select");
            td.appendChild(desc);
            date++;
          }

          tr.appendChild(td);
        }

        table.appendChild(tr);
        if (date > lastDate) break;
      }

      const holder = document.getElementById("calendarTable");
      holder.innerHTML = "";
      holder.appendChild(table);
      document.getElementById("saveBtn").style.display = "block";
    }

    document.getElementById("saveBtn").onclick = async () => {
      const btn = document.getElementById("saveBtn");
      const result = document.getElementById("saveResult");

      btn.disabled = true;
      btn.textContent = "é€å‡ºä¸­ï¼Œè«‹ç¨å€™â€¦";
      result.textContent = "";

      try {
        const selects = document.querySelectorAll("select[name]");
        const calendar = {};
        selects.forEach(sel => calendar[sel.name] = sel.value);

        const sixDays = document.getElementById("sixDaysInput").value.trim();
        const note = document.getElementById("noteInput").value.trim();

        const form = new URLSearchParams({
          lineId,
          calendar: JSON.stringify(calendar),
          sixDays,
          note
        });

        const res = await fetch(GAS_URL, { method: "POST", body: form });
        const text = await res.text();

        alert("âœ… è³‡æ–™å·²æˆåŠŸé€å‡ºï¼");
        liff.closeWindow();
      } catch (err) {
        result.textContent = "âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ï¼";
        result.style.color = "#d32f2f";
        console.error(err);
        btn.disabled = false;
        btn.textContent = "å„²å­˜ç­è¡¨";
      }
    };

    document.getElementById("confirmLineId").addEventListener("change", function () {
      document.getElementById("registerBtn").disabled = !this.checked;
    });

    window.onload = init;
  </script>
</body>
</html>
